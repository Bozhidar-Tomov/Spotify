# Документация на архитектурата на приложението

Проектът се състои от два основни компонента: клиент и сървър.

## Сървърна архитектура

### ServerMain

Основният entry point на приложението. Оттук се стартира сървърът. Компонентът е отделен от `SpotifySystem` с цел бъдещо добавяне на Reverse Proxy, множество инстанции на сървъра и Load Balancer. Той слуша за команда `QUIT`, която спира работата на сървъра.

### SpotifySystem

 The brain of the system. Настоящата имплементация е реализирана като **Singleton**.
**Отговорности:**

- Съхранява и обработва данните, като използва `DataManager` за входно-изходни (I/O) операции с файловете.
- Управлява жизнения цикъл на мрежовата връзка, имплементирана в модула `ServerDispatcher` на отделна нишка (`networkExecutor`), за да не блокира основната функционалност.
- Управлява жизнения цикъл на нишка, която периодично записва текущото състояние на системата във файлове чрез `scheduler`.
- Предоставя бизнес логиката за изпълнение на командите (напр. `login`, `search`, `play` и др.). Те връщат отговор, който се преобразува в `Response` и се изпраща по мрежата чрез `CommandSender`.
- Композира `AudioStreamer`, който е отговорен за стриймването на данни към клиента.
- Предоставя специфични private гетъри, необходими за изпълнението на командите.

**Проблеми:**

- Архитектурен тип „God object“ - командите е хубаво да се изнесат в отделни класове извън `SpotifySystem`.
- Синхронизация на методите - текущата синхронизация изглежда достатъчна, като до момента не са наблюдавани състезания за ресурси (race conditions).

### Commands (Команди)

Командният механизъм е йерархично структуриран.
**Компоненти:**

- **CommandDispatcher:** Централен компонент, който приема суровия текст от клиента, парсва го (включително аргументи в кавички) и делегира изпълнението към съответната команда.
- **CommandFactory:** Използва се за създаване на обекти от тип `Command` чрез `Map`, асоцииращ името на командата с нейната имплементация.
- **Command (интерфейс):** Дефинира общия договор за всички команди. Всяка конкретна команда (напр. `LoginCommand`, `PlaySongCommand`) имплементира метода `execute`.

### ServerDispatcher

Отговаря за мрежовата комуникация. `SpotifySystem` го инстанцира в отделна нишка. Използва Java NIO за неблокиращ сървър с буфери.
**Отговорности:**

- Създава `Selector`, към който закача `ServerSocketChannel` за приемане на клиентски заявки.
- Слуша за заявки в `runLoop()`, като делегира обработката на всяка заявка на нова виртуална нишка `RequestHandler` чрез метода `readClientRequest`.
- Задава `key.interestOps(0)`, за да предотврати повторно избиране от селектора по време на обработка. След приключване, `RequestHandler` възстановява режима `OP_READ`.
- `acceptClientRequest`: Регистрира нови клиентски връзки в селектора.
- Управлява жизнения цикъл на нишките, обработващи заявките.

### RequestHandler

Обработва индивидуалните заявки.
**Отговорности:**

- Прочита данните от мрежата и ги препраща към `CommandDispatcher` за парсване и изпълнение.
- Изпраща отговори към клиента чрез `ResponseSender`.
- След обработка събужда селектора чрез `key.selector().wakeup()`, за да продължи слушането за нови събития.

### ResponseSender & SocketResponseSender

- **ResponseSender:** Функционален интерфейс за изпращане на отговори (legacy - останал от по-ранна версия).
- **SocketResponseSender:** Имплементира `ResponseSender`. Преобразува обектите от тип `Response` в масиви от байтове и ги изпраща към съответния `SocketChannel` на клиента.

### AudioStreamer

Зарежда аудио файлове (WAV) и подготвя данните за стриймване.
**Отговорности:**

- Изпраща формата на аудио файла, за да подготви клиента за приемане на сурови данни.
- Стриймва данни на части с размер 4096 байта, прочетени от `AudioInputStream`.
- Изпраща съобщение при успешно приключване на стрийма.

### DataManager

Отговаря за (де)сериализацията на данни.

- Обектите от тип `User` се записват в двоичен вид, защото съдържат сурови данни - масив от байтове, представляващ hash and salt.
- Менажира записването на плейлисти и песни в JSON формат.

### Помощни класове

- **PasswordHandler:** Предоставя функционалност за хеширане и верифициране на пароли.
- **TestData:** Инструмент за генериране на първоначални тестови данни при стартиране на системата.

---

## Клиентска архитектура

По модела на сървъра е направена и клиентската архитектура.

### 1. Основни компоненти

#### ClientMain

The entry point на клиентското приложение. Отговаря за:

- Инициализиране на `SpotifyClient`.
- Управление четенеto на вход от конзолата.
- Предаване на командите към `SpotifyClient` за обработка.

#### SpotifyClient

Основният контролер на клиента.
**Отговорности:**

- **Мрежова връзка:** Отваря `SocketChannel` към сървъра и поддържа `PrintWriter` за изпращане на текстови команди.
- **Управление на сесията:** Съхранява текущия потребител (`UserDTO`) след успешно влизане в системата.
- Стартира нишка за `ResponseHandler`, която слуша за системни съобщения и аудио данни асинхронно.
- Инстанцира `AudioPlayer` за възпроизвеждане на песни.

### 2. Мрежова комуникация и обработка

#### ResponseHandler

Работи в отделна нишка и слуша за входящи данни от сървъра.
**Отговорности:**

- **Десериализация:** Преобразува входящите байтове обратно в обекти от тип `Response`.
- **Логика на отговорите:** В зависимост от съдържанието на отговора, обновява UI (през `ConsoleMenu`) или пренасочва аудио данни към `AudioPlayer`.
- **Обновяване на състоянието:** При успешно логване или създаване на плейлисти, автоматично обновява `UserDTO` обекта в `SpotifyClient`.

### 3. Аудио

#### AudioPlayer (интерфейс)

Дефинира сигнатурата основните методи.

#### StreamingAudioPlayer

Имплементира `AudioPlayer` за работа със данни по мрежа.

**Отговорности:**
- Менажира `SourceDataLine` за възпроизвеждане на сурови аудио байтове.
- Приема аудио формат от сървъра и настройва `SourceDataLine`.
- **Възпроизвеждане:** Препращане на аудио пакетите, получени от `ResponseHandler` в `SourceDataLine`. 
- **Завършване на стрийма:** При получаване на съобщение за край на стрийма, спира възпроизвеждането и освобождава ресурсите.

### 4. Потребителски интерфейс (View)

#### ConsoleMenu

Помощен клас за визуализация на информацията в конзолата.

- **Табличен изглед:** Форматира списъци с песни и плейлисти в подредени таблици.
- **Потребителско меню:** Показва списък с наличните команди и информация за текущия потребител.

[Линк към проекта в GitHub](https://github.com/Bozhidar-Tomov/Spotify)